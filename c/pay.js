const e=document.querySelectorAll(".tab-btn"),t=document.querySelectorAll(".tab-pane"),n=document.getElementById("biller-form"),a=document.getElementById("invoice-form"),o=document.getElementById("institution"),i=document.getElementById("association"),s=document.getElementById("institution-suggestions"),c=document.getElementById("association-suggestions"),r=document.getElementById("amount-container"),l=document.querySelector("#biller-form .submit-btn");let d,u,m=null,p=null,y=0;function g(e=null){null!==e?l.innerHTML=`Pay <strong>₦${parseFloat(e).toLocaleString()}</strong>`:l.textContent="Proceed to Payment"}async function f(e,t=""){const n=await async function(e){const t=new FormData;t.append("amount",e);try{const e=await fetch("/api/service-fee",{method:"POST",body:t}),n=await e.json();return console.log(n),n.fee}catch(e){const t=document.querySelectorAll(".summary-box");return t[t.length-1].innerHTML='\n            <div class="summary-content">\n                <div class="summary-row">\n                    <span>Error fetching service charge. Your internet connection is probably broken.</span>\n                    <span style="display: none" class="summary-note"><strong><br>Please try again later, or generate an invoice and pay with the generated ARN later.</strong></span>\n                </div>\n            </div>\n        ',document.querySelector(".submit-btn").style.display="none",document.getElementById("tos").style.display="none",document.getElementById("generateInvoice").style.display="none",0}}(parseFloat(e));y=n;let a=document.getElementById("summary-box");a||(a=document.createElement("div"),a.id="summary-box",a.className="summary-box",l.parentNode.insertBefore(a,document.getElementById("tos")));a.innerHTML=`\n        <div class="summary-content">\n            <div class="summary-row">\n                <span>Amount to pay:</span>\n                <span><strong>₦${n.toLocaleString()}</strong></span>\n            </div>\n            <div class="summary-note">Includes service charge</div>\n        </div>\n    `,g(n)}function v(){const e=document.getElementById("summary-box");e&&e.remove(),g()}function h(e,t){fetch(`/api/associations?q=${encodeURIComponent(e)}&institution_id=${t}`).then(e=>e.json()).then(e=>{!function(e){if(c.innerHTML="",0===e.length)return void(c.style.display="none");e.forEach(e=>{const t=document.createElement("div");t.className="suggestion-item",t.textContent=e.association_name,t.setAttribute("data-fees",e.fees),t.setAttribute("data-id",e.id),t.addEventListener("click",()=>{i.value=e.association_name,p=JSON.parse(e.fees),c.innerHTML="",c.style.display="none",function(e){if(r.innerHTML="",v(),"object"==typeof e&&Object.keys(e).length>1){const t=document.createElement("div");t.className="fee-options-container",Object.entries(e).forEach(([e,n])=>{const a=document.createElement("div");a.className="fee-option-wrapper";const o=document.createElement("input");o.type="radio",o.name="fee_category",o.value=n,o.id=`fee_${e}`,o.className="fee-radio";const i=document.createElement("label");i.htmlFor=`fee_${e}`,i.className="fee-label",i.innerHTML=`\n                <span class="fee-category">${e}</span>\n                <span class="fee-amount">₦${parseFloat(n).toLocaleString()}</span>\n            `,o.addEventListener("change",function(){this.checked&&f(n,e)}),a.appendChild(o),a.appendChild(i),t.appendChild(a)}),r.appendChild(t)}else{const t="object"==typeof e?Object.values(e)[0]:e,n=document.createElement("input");n.type="text",n.className="form-input",n.value=`₦${parseFloat(t).toLocaleString()}`,n.disabled=!0,n.name="amount",r.appendChild(n),f(t)}}(p)}),c.appendChild(t)}),c.style.display="block"}(e)}).catch(e=>{console.error("Error fetching associations:",e)})}function b(e,t=!1){const n=o.value,a=i.value,s=document.getElementById("fullname").value,c=document.getElementById("matnumber").value,r=document.getElementById("email_address").value,l=document.getElementById("phone_number").value;let d=y,u="";if(p&&"object"==typeof p&&Object.keys(p).length>1){const e=document.querySelector('input[name="fee_category"]:checked');if(!e)return alert("Please select a fee category"),!1;u=document.querySelector(`label[for="${e.id}"] .fee-category`).textContent}if(!(n&&a&&s&&c&&d&&l))return alert("Please FILL in ALL required fields"),!1;const g=document.getElementById("generateInvoice");if(t&&g){const e=g.innerHTML;g.innerHTML='<img src="/static/img/loading.gif" style="height: 20px; margin-right: 8px;"> Generating...',g.disabled=!0,g.setAttribute("data-original-text",e)}const f=new FormData;return f.append("institution",n),f.append("institution_id",m),f.append("association",a),f.append("fullname",s),f.append("matnumber",c),f.append("email",r),f.append("phone",l),f.append("amount",d),u&&f.append("category",u),t&&f.append("generate_invoice","true"),fetch(e,{method:"POST",body:f}).then(e=>e.json()).then(e=>{if(t&&g){const e=g.getAttribute("data-original-text");g.innerHTML=e,g.disabled=!1}return e.success?t?e.invoice_callback?window.location.href=e.invoice_callback:(alert("Invoice generated but no redirect URL provided"),console.log("Invoice data:",e)):window.location.href=e.authorization_url:alert("Request failed: "+e.message),e}).catch(e=>{if(console.error("Error:",e),alert("An error occurred while processing your request"),t&&g){const e=g.getAttribute("data-original-text");g.innerHTML=e,g.disabled=!1}throw e})}e.forEach(n=>{n.addEventListener("click",()=>{e.forEach(e=>e.classList.remove("active")),t.forEach(e=>e.classList.remove("active")),n.classList.add("active");const a=n.getAttribute("data-tab");document.getElementById(`${a}-tab`).classList.add("active")})}),o.addEventListener("input",function(){clearTimeout(d);const e=this.value.trim();if(i.value="",i.disabled=!0,i.placeholder="Select institution first",c.innerHTML="",c.style.display="none",r.innerHTML="",m=null,p=null,v(),e.length<1)return s.innerHTML="",void(s.style.display="none");d=setTimeout(()=>{!function(e){fetch(`/api/institutions?q=${encodeURIComponent(e)}`).then(e=>e.json()).then(e=>{!function(e){if(s.innerHTML="",0===e.length)return void(s.style.display="none");e.forEach(e=>{const t=document.createElement("div");t.className="suggestion-item",t.textContent=e.name,t.setAttribute("data-id",e.id),t.addEventListener("click",()=>{o.value=e.name,m=e.id,s.innerHTML="",s.style.display="none",i.disabled=!1,i.placeholder="Enter association name",i.value="",r.innerHTML="",p=null,v(),h("",m)}),s.appendChild(t)}),s.style.display="block"}(e)}).catch(e=>{console.error("Error fetching institutions:",e)})}(e)},150)}),i.addEventListener("input",function(){if(!m)return;clearTimeout(u);const e=this.value.trim();u=setTimeout(()=>{h(e,m)},300)}),i.addEventListener("focus",function(){m&&0===c.children.length?h("",m):m&&c.children.length>0&&(c.style.display="block")}),document.addEventListener("click",function(e){o.contains(e.target)||s.contains(e.target)||(s.style.display="none"),i.contains(e.target)||c.contains(e.target)||(c.style.display="none")}),n.addEventListener("submit",function(e){e.preventDefault(),b("/init-payment",!1)}),document.getElementById("generateInvoice").addEventListener("click",function(e){e.preventDefault(),b("/generate-invoice",!0)}),a.addEventListener("submit",function(e){e.preventDefault();const t=document.getElementById("invoice-number").value;document.getElementById("payer-email").value;t||alert("Please enter the ARN")}),document.addEventListener("DOMContentLoaded",function(){i.disabled=!0,i.placeholder="Select institution first"});