let e=1;let t="";function n(){document.getElementById("exportModal").style.display="none",document.getElementById("exportForm").reset()}async function a(e){e.preventDefault();const t=e.target,n=document.getElementById("verifyAccessKey").value,a=document.getElementById("newPresidentName").value.trim(),o=document.getElementById("newPresidentPhone").value.trim(),r=t.querySelector('button[type="submit"]'),d=r.textContent;if(n&&a&&o){r.textContent="Updating...",r.disabled=!0;try{const e=await fetch("/ajax/dashboard/change-admin",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({verify_key:n,new_president_name:a,new_president_phone:o})}),t=await e.json();if(t.success){const e=document.querySelector("#changeAdminModal.modal-body");document.querySelector("#changeAdminModal.modal-header h3").textContent="Administration Changed Successfully!",e.innerHTML=` <div class="success-state"> <div class="success-icon" style="text-align: center;font-size: 48px;color: var(--success-color);margin-bottom: 20px;">✓</div> <div class="warning-box" style="background: #fff3cd;border: 1px solid #ffeaa7;border-radius: var(--border-radius);padding: var(--spacing-md);margin-bottom: var(--spacing-lg);"> <p style="margin: 0;color: #856404;font-weight: bold;text-align: center;"> ⚠️ Save this access key immediately! </p> </div> <div class="access-key-display" style="background: var(--secondary-color);padding: var(--spacing-lg);border-radius: var(--border-radius);margin-bottom: var(--spacing-lg);text-align: center;"> <label style="display: block;margin-bottom: var(--spacing-sm);font-weight: bold;color: var(--text-color);">Your New Access Key:</label> <div style="display: flex;gap: var(--spacing-sm);align-items: center;justify-content: center;"> <input type="text" id="newAccessKeyDisplay" value="${t.new_access_key}" readonly style="flex: 1;padding: var(--spacing-md);font-family: monospace;font-size: var(--font-size-sm);text-align: center;background: white;border: 1px solid var(--border-color);border-radius: var(--border-radius);"> <button type="button" onclick="copyAccessKey()" style="background: var(--primary-color);color: white;border: none;padding: var(--spacing-md)var(--spacing-lg);border-radius: var(--border-radius);cursor: pointer;white-space: nowrap;"> Copy </button> </div> <small style="display: block;margin-top: var(--spacing-sm);color: var(--text-light);"> Click the copy button to save your access key </small> </div> <div class="instructions" style="background: #d1ecf1;border: 1px solid #bee5eb;border-radius: var(--border-radius);padding: var(--spacing-md);margin-bottom: var(--spacing-lg);"> <p style="margin: 0;color: #0c5460;"> <strong>Next steps:</strong> <br>• Save this key in a secure location <br>• Share it with the financial secretary or any other relevant administration officer <br>• You'll need this key to access the dashboard </p> </div> <div class="form-actions" style="text-align: center;"> <button type="button" onclick="closeChangeAdminModal();window.location=window.location;" class="submit-btn" style="min-width: 120px;"> Done </button> </div> </div> `;const n=document.getElementById("newAccessKeyDisplay");n&&(n.focus(),n.select())}else alert("Error: "+t.message)}catch(e){alert("Network error.Please try again.")}finally{r.textContent=d,r.disabled=!1}}else alert("Please fill all fields")}function o(e,t){let n;return function(...a){clearTimeout(n),n=setTimeout(()=>{clearTimeout(n),e(...a)},t)}}function r(){e>1&&(e--,i())}function d(){e++,i()}async function i(){const n=document.querySelector("#paymentsTable tbody");document.getElementById("prevPage"),document.getElementById("nextPage"),document.getElementById("pageInfo");n.innerHTML='<tr><td colspan="6" style="text-align: center;">Loading...</td></tr>';try{const a=await fetch("/ajax/dashboard/payments",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({page:e,search:t,pageSize:20})}),o=await a.json();o.success?(c(o.payments),s(o.hasMore)):n.innerHTML='<tr><td colspan="6" style="text-align: center;">Error loading payments</td></tr>'}catch(e){n.innerHTML='<tr><td colspan="6" style="text-align: center;">Network error</td></tr>'}}function c(e){const t=document.querySelector("#paymentsTable tbody");0!==e.length?t.innerHTML=e.map(e=>` <tr> <td>${m(e.fullname)}</td> <td>${m(e.administration)}</td> <td>₦${parseFloat(e.amount).toLocaleString("en-US",{minimumFractionDigits:2,maximumFractionDigits:2})}</td> <td>${y(e.created_at)}</td> </tr> `).join(""):t.innerHTML='<tr><td colspan="6" style="text-align: center;">No payments found</td></tr>'}function s(t){const n=document.getElementById("prevPage"),a=document.getElementById("nextPage"),o=document.getElementById("pageInfo");n.disabled=1===e,a.disabled=!t,o.textContent=`Page ${e}`}async function l(e){e.preventDefault();const t=e.target,a=document.getElementById("exportStartDate").value,o=document.getElementById("exportEndDate").value,r=document.getElementById("exportType").value,d=t.querySelector('button[type="submit"]'),i=d.textContent;if(a&&o){d.textContent="Exporting...",d.disabled=!0;try{const e=await fetch("/ajax/dashboard/export",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({start_date:a,end_date:o,export_type:r})}),t=await e.json();if(t.success){const e=document.createElement("a");e.href=t.download_url,e.download=t.filename,document.body.appendChild(e),e.click(),document.body.removeChild(e),n()}else alert("Export failed: "+t.message)}catch(e){alert("Network error during export.")}finally{d.textContent=i,d.disabled=!1}}else alert("Please select date range")}function m(e){return e.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;")}function y(e){return new Date(e).toLocaleDateString("en-US",{year:"numeric",month:"short",day:"numeric"})}function c(e){const t=document.querySelector("#paymentsTable tbody");e&&0!==e.length?t.innerHTML=e.map(e=>` <tr> <td>${m(e.fullname||"N/A")}</td> <td>${m(e.administration||"N/A")}</td> <td>₦${parseFloat(e.amount||0).toLocaleString("en-US",{minimumFractionDigits:2,maximumFractionDigits:2})}</td> <td>${y(e.created_at)}</td> </tr> `).join(""):t.innerHTML='<tr><td colspan="6" style="text-align: center;">No payments found</td></tr>'}function y(e){if(!e)return"N/A";try{return new Date(e).toLocaleDateString("en-US",{year:"numeric",month:"short",day:"numeric"})}catch(e){return"Invalid Date"}}async function i(){const n=document.querySelector("#paymentsTable tbody");document.getElementById("prevPage"),document.getElementById("nextPage"),document.getElementById("pageInfo");if(n){n.innerHTML='<tr><td colspan="6" style="text-align: center;">Loading...</td></tr>';try{const a=await fetch("/ajax/dashboard/payments",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({page:e,search:t,pageSize:20})}),o=await a.json();o.success?(c(o.payments||[]),s(o.hasMore||!1)):n.innerHTML='<tr><td colspan="6" style="text-align: center;">Error loading payments: '+(o.message||"Unknown error")+"</td></tr>"}catch(e){n.innerHTML='<tr><td colspan="6" style="text-align: center;">Network error loading payments</td></tr>'}}}document.addEventListener("DOMContentLoaded",function(){!function(){const e=document.getElementById("searchPayments"),t=document.getElementById("prevPage"),n=document.getElementById("nextPage"),c=document.getElementById("changeAdminForm"),s=document.getElementById("exportForm");e&&e.addEventListener("input",o(e,300));t&&t.addEventListener("click",r);n&&n.addEventListener("click",d);c&&c.addEventListener("submit",a);s&&s.addEventListener("submit",l);document.querySelector("#paymentsTable")&&i()}()}),window.addEventListener("click",function(e){const t=document.getElementById("changeAdminModal"),a=document.getElementById("otherOfficialsModal"),o=document.getElementById("logoModal"),r=document.getElementById("exportModal");e.target===t&&(document.getElementById("changeAdminModal").style.display="none",document.getElementById("changeAdminForm").reset()),e.target===r&&n(),e.target===a&&(document.getElementById("otherOfficialsModal").style.display="none",document.getElementById("otherOfficialsForm").reset()),e.target===o&&(document.getElementById("logoModal").style.display="none",document.getElementById("logoForm").reset())});